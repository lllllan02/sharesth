<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>查询用户分享记录</title>
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <div class="container">
        <h1>查询用户分享记录</h1>
        <div class="search-form">
            <input type="text" id="sourceInput" placeholder="输入用户来源ID（例如：IP地址）">
            <button id="searchBtn">查询</button>
        </div>
        
        <div id="resultsContainer" class="results">
            <div class="user-info">
                <p>用户来源: <span id="sourceId"></span></p>
                <p>分享内容数量: <span id="contentCount"></span></p>
            </div>
            
            <div class="filter-box">
                <span class="filter-label">搜索标题:</span>
                <input type="text" id="titleFilter" class="filter-input" placeholder="输入标题关键词过滤结果...">
            </div>
            
            <ul id="contentList" class="content-list">
                <!-- 内容项将通过JavaScript动态添加 -->
            </ul>
            
            <div id="noResults" class="no-results" style="display: none;">
                <p>未找到该用户的分享记录</p>
            </div>
            
            <div id="noFilterResults" class="no-results hidden">
                <p>没有匹配的标题</p>
                <p>尝试其他关键词或清除过滤条件</p>
            </div>
        </div>
        
        <div class="back-link">
            <a href="/">返回首页</a>
        </div>
    </div>

    <script>
        // 存储获取到的所有内容
        let allItems = [];
    
        document.getElementById('searchBtn').addEventListener('click', function() {
            const source = document.getElementById('sourceInput').value.trim();
            if (source === '') {
                alert('请输入用户来源ID');
                return;
            }
            
            fetch(`/api/source-content?source=${encodeURIComponent(source)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('查询失败');
                    }
                    return response.json();
                })
                .then(data => {
                    // 存储数据
                    allItems = data.items || [];
                    displayResults(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('查询失败: ' + error.message);
                });
        });
        
        // 添加标题过滤功能
        document.getElementById('titleFilter').addEventListener('input', function() {
            filterContentByTitle();
        });
        
        function filterContentByTitle() {
            const filterText = document.getElementById('titleFilter').value.trim().toLowerCase();
            
            if (filterText === '') {
                // 显示所有内容
                displayFilteredItems(allItems);
                document.getElementById('noFilterResults').classList.add('hidden');
                return;
            }
            
            // 按标题过滤内容
            const filteredItems = allItems.filter(item => {
                return item.title && item.title.toLowerCase().includes(filterText);
            });
            
            // 显示过滤后的内容
            displayFilteredItems(filteredItems);
            
            // 处理无结果情况
            if (filteredItems.length === 0) {
                document.getElementById('noFilterResults').classList.remove('hidden');
            } else {
                document.getElementById('noFilterResults').classList.add('hidden');
            }
        }
        
        function displayResults(data) {
            const resultsContainer = document.getElementById('resultsContainer');
            const sourceIdEl = document.getElementById('sourceId');
            const contentCountEl = document.getElementById('contentCount');
            const noResultsEl = document.getElementById('noResults');
            
            // 显示结果容器
            resultsContainer.style.display = 'block';
            
            // 填充用户信息
            sourceIdEl.textContent = data.source;
            contentCountEl.textContent = data.count;
            
            // 处理内容显示
            if (data.count > 0) {
                // 有结果，显示内容列表
                noResultsEl.style.display = 'none';
                
                // 按时间逆序排序内容
                allItems.sort((a, b) => {
                    return new Date(b.createTime) - new Date(a.createTime);
                });
                
                // 显示内容
                displayFilteredItems(allItems);
            } else {
                // 无结果
                document.getElementById('contentList').innerHTML = '';
                noResultsEl.style.display = 'block';
                document.getElementById('titleFilter').disabled = true;
            }
        }
        
        function displayFilteredItems(items) {
            const contentListEl = document.getElementById('contentList');
            
            // 清空内容列表
            contentListEl.innerHTML = '';
            
            // 添加内容项
            items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'content-item';
                
                const header = document.createElement('div');
                header.className = 'content-header';
                
                const typeSpan = document.createElement('span');
                typeSpan.className = 'content-type ' + (item.type === 'text' ? 'type-text' : 'type-image');
                typeSpan.textContent = item.type === 'text' ? '文本内容' : '图片内容';
                
                const timeSpan = document.createElement('span');
                timeSpan.className = 'content-time';
                const createDate = new Date(item.createTime);
                const formatOptions = { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                timeSpan.textContent = createDate.toLocaleString('zh-CN', formatOptions);
                
                header.appendChild(typeSpan);
                header.appendChild(timeSpan);
                
                // 添加标题
                const titleDiv = document.createElement('div');
                titleDiv.className = 'content-title';
                titleDiv.textContent = item.title || '无标题';
                
                const idDiv = document.createElement('div');
                idDiv.className = 'content-id';
                idDiv.textContent = `短链接ID: ${item.id}`;
                
                const linkDiv = document.createElement('div');
                linkDiv.className = 'content-link';
                
                const link = document.createElement('a');
                link.href = item.link;
                link.textContent = '查看内容';
                link.target = '_blank';
                
                linkDiv.appendChild(link);
                
                li.appendChild(header);
                li.appendChild(titleDiv);
                li.appendChild(idDiv);
                li.appendChild(linkDiv);
                
                contentListEl.appendChild(li);
            });
        }
    </script>
</body>
</html> 