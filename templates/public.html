<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公开内容 - ShareSTH</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <!-- 引入Toastify CSS -->
    <link rel="stylesheet" href="/static/vendor/toastify/toastify.min.css">
    <!-- 引入Font Awesome图标库 -->
    <link rel="stylesheet" href="/static/vendor/fontawesome/all.min.css">
</head>
<body>
    <div class="container">
        <h1>公开分享内容 - ShareSTH</h1>
        
        <div class="public-content-header">
            <p>这里展示的是所有用户公开分享的内容，您可以浏览和搜索这些内容。</p>
            
            <!-- 筛选和搜索 -->
            <div class="filter-controls">
                <div class="filter-box">
                    <label class="filter-label">
                        <i class="fas fa-filter"></i> 按类型筛选:
                    </label>
                    <select id="content-type-filter" class="filter-select">
                        <option value="all">全部</option>
                        <option value="markdown">Markdown</option>
                        <option value="text">文本</option>
                        <option value="image">图片</option>
                    </select>
                </div>
                
                <div class="search-box">
                    <input type="text" id="content-search" class="search-input" placeholder="搜索标题...">
                    <button id="search-button" class="search-button"><i class="fas fa-search"></i> 搜索</button>
                </div>
            </div>
        </div>
        
        <!-- 加载提示 -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>正在加载内容...</p>
        </div>
        
        <!-- 内容列表 -->
        <div id="content-container" class="content-container" style="display:none;">
            <div class="content-stats">
                <p>共找到 <span id="content-count">0</span> 项公开内容</p>
            </div>
            
            <ul id="content-list" class="content-list">
                <!-- 内容将通过 JavaScript 动态生成 -->
            </ul>
            
            <!-- 无内容提示 -->
            <div id="no-content" class="no-content" style="display:none;">
                <i class="fas fa-info-circle"></i>
                <p>当前没有公开的内容。</p>
            </div>
            
            <!-- 无搜索结果提示 -->
            <div id="no-filter-results" class="no-search-result hidden">
                <i class="fas fa-search"></i>
                <p>没有找到符合条件的内容</p>
            </div>
        </div>
        
        <div class="footer">
            <a href="/"><i class="fas fa-home"></i> 返回首页</a>
            <a href="/my-content"><i class="fas fa-list"></i> 我的分享</a>
            <a href="/search"><i class="fas fa-search"></i> 查询用户分享</a>
        </div>
    </div>
    
    <!-- 引入Toastify JS -->
    <script src="/static/vendor/toastify/toastify.min.js"></script>
    <!-- 引入公共JS -->
    <script src="/static/js/common.js"></script>
    
    <script>
        // 页面加载完成后获取公开内容
        document.addEventListener('DOMContentLoaded', fetchPublicContent);
        
        // 筛选逻辑
        document.getElementById('content-type-filter').addEventListener('change', filterContent);
        document.getElementById('content-search').addEventListener('input', debounce(filterContent, 300));
        document.getElementById('search-button').addEventListener('click', filterContent);
        
        // 获取所有公开内容
        function fetchPublicContent() {
            fetch('/api/public-content', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('获取数据失败');
                }
                return response.json();
            })
            .then(data => {
                // 隐藏加载中提示
                document.getElementById('loading').style.display = 'none';
                // 显示内容容器
                document.getElementById('content-container').style.display = 'block';
                
                // 存储数据供筛选使用
                window.allPublicItems = data.items || [];
                
                // 显示内容
                displayContent(data);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loading').innerHTML = `
                    <p>获取数据失败: ${error.message}</p>
                    <p>请刷新页面重试</p>
                `;
            });
        }
        
        // 显示内容
        function displayContent(data) {
            const contentCountEl = document.getElementById('content-count');
            
            // 更新内容计数
            contentCountEl.textContent = data.count;
            
            // 显示内容列表
            if (data.count > 0) {
                // 按时间逆序排序内容
                window.allPublicItems.sort((a, b) => {
                    return new Date(b.createTime) - new Date(a.createTime);
                });
                
                // 显示所有内容
                displayFilteredContent(window.allPublicItems);
            } else {
                // 无内容
                document.getElementById('content-list').style.display = 'none';
                document.getElementById('no-content').style.display = 'block';
            }
        }
        
        // 筛选内容
        function filterContent() {
            const typeFilter = document.getElementById('content-type-filter').value;
            const searchText = document.getElementById('content-search').value.trim().toLowerCase();
            
            if (!window.allPublicItems || window.allPublicItems.length === 0) {
                return;
            }
            
            // 应用筛选
            let filteredItems = window.allPublicItems;
            
            // 按类型筛选
            if (typeFilter !== 'all') {
                filteredItems = filteredItems.filter(item => item.type === typeFilter);
            }
            
            // 按搜索文本筛选
            if (searchText) {
                filteredItems = filteredItems.filter(item => 
                    item.title.toLowerCase().includes(searchText)
                );
            }
            
            // 显示筛选结果
            displayFilteredContent(filteredItems);
        }
        
        // 显示筛选后的内容
        function displayFilteredContent(items) {
            const contentListEl = document.getElementById('content-list');
            const noContentEl = document.getElementById('no-content');
            const noFilterResultsEl = document.getElementById('no-filter-results');
            
            // 清空内容列表
            contentListEl.innerHTML = '';
            
            if (items.length > 0) {
                // 有结果，显示内容列表
                noContentEl.style.display = 'none';
                contentListEl.style.display = 'block';
                noFilterResultsEl.classList.add('hidden');
                
                // 添加内容项
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'content-item';
                    
                    const header = document.createElement('div');
                    header.className = 'content-header';
                    
                    const typeSpan = document.createElement('span');
                    let typeClass = 'type-text';
                    let typeText = '文本内容';
                    let typeIcon = '<i class="fas fa-file-alt"></i> ';
                    
                    if (item.type === 'markdown') {
                        typeClass = 'type-markdown';
                        typeText = 'Markdown 内容';
                        typeIcon = '<i class="fab fa-markdown"></i> ';
                    } else if (item.type === 'image') {
                        typeClass = 'type-image';
                        typeText = '图片内容';
                        typeIcon = '<i class="fas fa-image"></i> ';
                    }
                    
                    typeSpan.className = 'content-type ' + typeClass;
                    typeSpan.innerHTML = typeIcon + typeText;
                    
                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'content-time';
                    const createDate = new Date(item.createTime);
                    timeSpan.innerHTML = '<i class="far fa-clock"></i> ' + createDate.toLocaleString();
                    
                    header.appendChild(typeSpan);
                    header.appendChild(timeSpan);
                    
                    const title = document.createElement('h3');
                    title.className = 'content-title';
                    title.textContent = item.title || '无标题';
                    
                    const link = document.createElement('div');
                    link.className = 'content-link';
                    link.innerHTML = `<a href="${item.link}" target="_blank"><i class="fas fa-external-link-alt"></i> 查看内容</a>`;
                    
                    li.appendChild(header);
                    li.appendChild(title);
                    li.appendChild(link);
                    
                    contentListEl.appendChild(li);
                });
            } else if (document.getElementById('content-search').value.trim() || document.getElementById('content-type-filter').value !== 'all') {
                // 筛选后无结果
                contentListEl.style.display = 'none';
                noContentEl.style.display = 'none';
                noFilterResultsEl.classList.remove('hidden');
            } else {
                // 根本没有内容
                contentListEl.style.display = 'none';
                noContentEl.style.display = 'block';
                noFilterResultsEl.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
