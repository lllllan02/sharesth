<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShareSTH - 内容分享平台</title>
    <!-- 引入 Markdown 编辑器样式 (优先加载) -->
    <link rel="stylesheet" href="/static/vendor/easymde/easymde.min.css">
    <link rel="stylesheet" href="/static/css/styles.css">
    <!-- 引入Toastify CSS -->
    <link rel="stylesheet" href="/static/vendor/toastify/toastify.min.css">
    <!-- 引入Font Awesome图标库 -->
    <link rel="stylesheet" href="/static/vendor/fontawesome/all.min.css">
    <style>
        .tooltip {
            position: absolute;
            background-color: #333;
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
            max-width: 250px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .tooltip-icon {
            cursor: help;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ShareSTH - 内容分享平台</h1>
        
        <!-- 内容类型选择标签 -->
        <div class="tabs">
            <div class="tab active" data-type="markdown"><i class="fab fa-markdown"></i> Markdown</div>
            <div class="tab" data-type="text"><i class="fas fa-file-alt"></i> 纯文本</div>
            <div class="tab" data-type="image"><i class="fas fa-image"></i> 图片</div>
        </div>
        
        <!-- 标题输入 (对所有类型通用) -->
        <div class="common-content">
            <div class="input-group">
                <label for="content-title" class="input-label">标题 (可选)</label>
                <input type="text" id="content-title" class="title-input" placeholder="输入内容标题...">
            </div>
            
            <div class="privacy-setting">
                <label class="privacy-label">
                    <input type="checkbox" id="is-public"> 
                    <span>公开此内容 <i class="fas fa-question-circle tooltip-icon" data-tooltip="公开内容将显示在公共页面上，任何人都可以浏览"></i></span>
                </label>
            </div>
        </div>
        
        <!-- Markdown 内容 -->
        <div class="content active" id="markdown-content">
            <label class="input-label">Markdown 内容</label>
            <div class="editor-container">
                <textarea id="md-editor"></textarea>
            </div>
            
            <div class="preview-toggle" id="toggle-preview"><i class="fas fa-eye"></i> 显示预览</div>
            <div class="preview-container hidden" id="preview-container"></div>
            
            <div class="button-group">
                <button class="button" id="share-md"><i class="fas fa-share-alt"></i> 分享内容</button>
            </div>
        </div>
        
        <!-- 纯文本内容 -->
        <div class="content hidden" id="text-content">
            <label class="input-label">文本内容</label>
            <textarea id="text-editor" placeholder="在这里输入要分享的纯文本内容..."></textarea>
            
            <div class="button-group">
                <button class="button" id="share-text"><i class="fas fa-share-alt"></i> 分享内容</button>
            </div>
        </div>
        
        <!-- 图片内容 -->
        <div class="content hidden" id="image-content">
            <label class="input-label">上传图片</label>
            <div class="file-input-wrapper">
                <div class="file-input-button"><i class="fas fa-upload"></i> 选择图片文件</div>
                <input type="file" id="image-upload" accept="image/*">
            </div>
            
            <div class="image-preview-container hidden" id="image-preview-wrapper">
                <img id="preview-image" src="#" alt="预览图片">
            </div>
            
            <div class="button-group">
                <button class="button" id="share-image" disabled><i class="fas fa-share-alt"></i> 分享图片</button>
            </div>
        </div>
        
        <div class="result hidden" id="result">
            <p>您的短链接已生成：</p>
            <p class="shortlink" id="shortlink"></p>
            <div class="button-group">
                <button class="button copy-button" id="copy-button"><i class="fas fa-copy"></i> 复制链接</button>
                <button class="button reset-button" id="reset-form"><i class="fas fa-redo"></i> 继续分享</button>
            </div>
            
            <div class="social-share hidden">
                <p>分享到社交平台：</p>
                <div class="share-buttons">
                    <button class="share-btn wechat-btn" id="wechat-share" title="分享到微信"><i class="fab fa-weixin"></i></button>
                    <button class="share-btn qq-btn" id="qq-share" title="分享到QQ"><i class="fab fa-qq"></i></button>
                    <button class="share-btn weibo-btn" id="weibo-share" title="分享到微博"><i class="fab fa-weibo"></i></button>
                </div>
            </div>
        </div>
        
        <div class="tips" id="markdown-tips">
            <h3><i class="fas fa-lightbulb"></i> Markdown 小技巧</h3>
            <ul>
                <li><i class="fas fa-heading"></i> 使用 # 创建标题 (# 一级标题, ## 二级标题)</li>
                <li><i class="fas fa-bold"></i> 使用 **文本** 或 __文本__ 来加粗文本</li>
                <li><i class="fas fa-italic"></i> 使用 *文本* 或 _文本_ 来斜体显示</li>
                <li><i class="fas fa-list-ul"></i> 使用 - 或 * 创建无序列表</li>
                <li><i class="fas fa-list-ol"></i> 使用 1. 2. 3. 创建有序列表</li>
                <li><i class="fas fa-link"></i> 插入链接: [链接文本](URL)</li>
                <li><i class="fas fa-image"></i> 插入图片: ![替代文本](图片URL)</li>
                <li><i class="fas fa-table"></i> 创建表格: | 表头 | 表头 | 然后下一行 | --- | --- |</li>
            </ul>
        </div>
        
        <div class="footer">
            <a href="/my-content"><i class="fas fa-list"></i> 我的分享</a>
            <a href="/search"><i class="fas fa-search"></i> 查询用户分享</a>
            <a href="/public"><i class="fas fa-globe"></i> 浏览公开内容</a>
        </div>
    </div>
    
    <!-- 引入 Markdown 编辑器 -->
    <script src="/static/vendor/easymde/easymde.min.js"></script>
    <!-- 引入 Markdown 渲染库 -->
    <script src="/static/vendor/marked/marked.min.js"></script>
    <!-- 引入Toastify JS库 -->
    <script src="/static/vendor/toastify/toastify.min.js"></script>
    <!-- 引入公共JS -->
    <script src="/static/js/common.js"></script>
    
    <script>
        // 初始化 Markdown 编辑器
        const easyMDE = new EasyMDE({
            element: document.getElementById('md-editor'),
            spellChecker: false,
            autofocus: true,
            placeholder: '在这里编写您要分享的 Markdown 内容...',
            toolbar: [
                'bold', 'italic', 'heading', '|', 
                'quote', 'unordered-list', 'ordered-list', '|',
                'link', 
                {
                    name: 'custom-image',
                    action: function(editor) {
                        const cm = editor.codemirror;
                        const stat = editor.getState(cm);
                        const options = editor.options;
                        const imageUploadFunction = options.imageUploadFunction;
                        
                        // 创建文件输入框
                        const fileInput = document.createElement('input');
                        fileInput.type = 'file';
                        fileInput.accept = 'image/*';
                        fileInput.style.display = 'none';
                        document.body.appendChild(fileInput);
                        
                        // 模拟点击文件输入框
                        fileInput.click();
                        
                        // 监听文件选择事件
                        fileInput.onchange = function() {
                            if (fileInput.files && fileInput.files.length > 0) {
                                const file = fileInput.files[0];
                                
                                // 显示加载提示
                                const cursor = cm.getCursor();
                                const placeholderText = `![上传中...](正在上传 ${file.name})`;
                                cm.replaceRange(placeholderText, cursor);
                                
                                // 调用上传函数
                                if (imageUploadFunction) {
                                    imageUploadFunction(file, 
                                        // 成功回调
                                        function(url) {
                                            const imageMarkdown = `![${file.name}](${url})`;
                                            cm.setValue(cm.getValue().replace(placeholderText, imageMarkdown));
                                            showToast('图片上传成功！');
                                        },
                                        // 失败回调
                                        function(error) {
                                            cm.setValue(cm.getValue().replace(placeholderText, ''));
                                            showToast('图片上传失败: ' + error);
                                        }
                                    );
                                }
                            }
                            
                            // 清理文件输入框
                            document.body.removeChild(fileInput);
                        };
                    },
                    className: 'fa fa-upload',
                    title: '上传图片',
                },
                'image', 'table', '|',
                'preview', 'side-by-side', 'fullscreen', '|',
                'guide'
            ],
            status: false,
            renderingConfig: {
                codeSyntaxHighlighting: true,
            },
            tabSize: 4,
            toolbarTips: true,
            toolbarGuideIcon: true,
            imageUploadFunction: function(file, onSuccess, onError) {
                const formData = new FormData();
                formData.append('image', file);
                
                fetch('/upload/image', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('服务器响应错误: ' + response.status);
                    }
                    return response.json();
                })
                .then(result => {
                    console.log('图片上传响应:', result); // 添加调试信息
                    if (result.success && result.file && result.file.url) {
                        onSuccess(result.file.url);
                    } else {
                        onError(result.error || '上传失败');
                    }
                })
                .catch(error => {
                    console.error('上传图片失败:', error);
                    onError('上传图片失败: ' + error.message);
                });
            }
        });
        
        // 工具提示功能初始化
        document.addEventListener('DOMContentLoaded', function() {
            const tooltipIcons = document.querySelectorAll('.tooltip-icon');
            tooltipIcons.forEach(icon => {
                icon.addEventListener('mouseenter', function(e) {
                    const tooltip = document.createElement('div');
                    tooltip.className = 'tooltip';
                    tooltip.textContent = this.getAttribute('data-tooltip');
                    document.body.appendChild(tooltip);
                    
                    const rect = this.getBoundingClientRect();
                    tooltip.style.top = (rect.top - tooltip.offsetHeight - 5) + 'px';
                    tooltip.style.left = (rect.left + rect.width/2 - tooltip.offsetWidth/2) + 'px';
                });
                
                icon.addEventListener('mouseleave', function() {
                    const tooltips = document.querySelectorAll('.tooltip');
                    tooltips.forEach(t => t.remove());
                });
            });
        });
        
        // 标签切换功能
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // 如果已经显示了结果，先重置表单
                if (!document.getElementById('result').classList.contains('hidden')) {
                    resetForm();
                }
                
                // 移除所有标签的active类
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                // 给当前点击的标签添加active类
                this.classList.add('active');
                
                // 隐藏所有内容
                document.querySelectorAll('.content').forEach(content => content.classList.add('hidden'));
                
                // 显示对应的内容
                const type = this.getAttribute('data-type');
                document.getElementById(`${type}-content`).classList.remove('hidden');
                
                // 显示或隐藏 Markdown 小技巧
                if (type === 'markdown') {
                    document.getElementById('markdown-tips').style.display = 'block';
                } else {
                    document.getElementById('markdown-tips').style.display = 'none';
                }
            });
        });
        
        // 预览切换
        document.getElementById('toggle-preview').addEventListener('click', function() {
            const previewContainer = document.getElementById('preview-container');
            
            if (previewContainer.classList.contains('hidden')) {
                // 显示预览前清空容器
                previewContainer.innerHTML = '';
                
                // 显示预览
                previewContainer.classList.remove('hidden');
                
                try {
                    // 渲染 Markdown 内容
                    const markdownContent = easyMDE.value();
                    if (markdownContent.trim()) {
                        // 使用 marked 解析 Markdown
                        const html = marked.parse(markdownContent);
                        previewContainer.innerHTML = html;
                    } else {
                        previewContainer.innerHTML = '<div class="empty-preview">请先输入 Markdown 内容</div>';
                    }
                } catch (error) {
                    console.error('Markdown 渲染出错:', error);
                    previewContainer.innerHTML = '<div class="error-preview">Markdown 渲染失败，请检查内容格式</div>';
                }
                
                this.innerHTML = '<i class="fas fa-eye-slash"></i> 隐藏预览';
            } else {
                // 隐藏预览
                previewContainer.classList.add('hidden');
                this.innerHTML = '<i class="fas fa-eye"></i> 显示预览';
            }
        });
        
        // 图片上传预览
        document.getElementById('image-upload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewWrapper = document.getElementById('image-preview-wrapper');
                    const previewImage = document.getElementById('preview-image');
                    
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                    previewWrapper.classList.remove('hidden');
                    
                    // 启用分享按钮
                    document.getElementById('share-image').disabled = false;
                };
                reader.readAsDataURL(file);
            }
        });
        
        // 禁用按钮函数
        function disableButton(button, text) {
            button.disabled = true;
            button.style.backgroundColor = '#BBDEFB';
            button.style.cursor = 'not-allowed';
            button.innerHTML = text || '<i class="fas fa-spinner fa-spin"></i> 处理中...';
        }
        
        // 重置按钮状态
        function resetButton(button, originalText) {
            button.disabled = false;
            button.style.backgroundColor = '#2196F3';
            button.style.cursor = 'pointer';
            button.innerHTML = originalText;
        }
        
        // 重置表单
        function resetForm() {
            // 清除标题
            document.getElementById('content-title').value = '';
            document.getElementById('content-title').removeAttribute('readonly');
            
            // 重置 Markdown 编辑器
            easyMDE.value('');
            easyMDE.codemirror.setOption('readOnly', false);
            
            // 重置文本编辑器
            document.getElementById('text-editor').value = '';
            document.getElementById('text-editor').removeAttribute('readonly');
            
            // 重置图片上传
            document.getElementById('image-upload').value = '';
            document.getElementById('preview-image').src = '#';
            document.getElementById('image-preview-wrapper').classList.add('hidden');
            document.getElementById('share-image').disabled = true;
            
            // 恢复所有按钮状态
            document.querySelectorAll('button.button').forEach(btn => {
                btn.disabled = false;
                btn.style.backgroundColor = '#2196F3';
                btn.style.cursor = 'pointer';
            });
            
            // 重置分享按钮文本
            document.getElementById('share-md').innerHTML = '<i class="fas fa-share-alt"></i> 分享内容';
            document.getElementById('share-text').innerHTML = '<i class="fas fa-share-alt"></i> 分享内容';
            document.getElementById('share-image').innerHTML = '<i class="fas fa-share-alt"></i> 分享图片';
            
            // 隐藏结果区域
            document.getElementById('result').classList.add('hidden');
            document.getElementById('shortlink').textContent = '';
            
            // 隐藏预览
            document.getElementById('preview-container').classList.add('hidden');
            document.getElementById('toggle-preview').innerHTML = '<i class="fas fa-eye"></i> 显示预览';
        }
        
        // 继续分享按钮事件
        document.getElementById('reset-form').addEventListener('click', function() {
            resetForm();
        });
        
        // 复制链接
        document.getElementById('copy-button').addEventListener('click', function() {
            const shortlink = document.getElementById('shortlink').textContent;
            copyToClipboard(shortlink);
        });
        
        // 社交分享功能
        document.getElementById('wechat-share').addEventListener('click', function() {
            const shortLink = document.getElementById('shortlink').textContent;
            // 对于微信，通常是显示二维码供扫描，或打开微信网页版
            showToast('请打开微信扫一扫，扫描链接二维码分享');
            // 这里可以添加显示二维码的代码，或者直接打开微信的网页版分享
            window.open(`https://w.url.cn/s/A${encodeURIComponent(shortLink)}`);
        });
        
        document.getElementById('qq-share').addEventListener('click', function() {
            const shortLink = document.getElementById('shortlink').textContent;
            const title = document.getElementById('content-title').value.trim() || '分享内容';
            window.open(`https://connect.qq.com/widget/shareqq/index.html?url=${encodeURIComponent(shortLink)}&title=${encodeURIComponent(title)}`);
        });
        
        document.getElementById('weibo-share').addEventListener('click', function() {
            const shortLink = document.getElementById('shortlink').textContent;
            const title = document.getElementById('content-title').value.trim() || '分享内容';
            window.open(`https://service.weibo.com/share/share.php?url=${encodeURIComponent(shortLink)}&title=${encodeURIComponent(title)}`);
        });
        
        // Markdown 分享
        document.getElementById('share-md').addEventListener('click', function() {
            const button = this;
            const originalHTML = button.innerHTML;
            
            const mdContent = easyMDE.value().trim();
            if (!mdContent) {
                showToast('请输入要分享的 Markdown 内容');
                return;
            }
            
            disableButton(button);
            
            const title = document.getElementById('content-title').value.trim();
            const isPublic = document.getElementById('is-public').checked;
            
            const formData = new FormData();
            formData.append('content', mdContent);
            formData.append('type', 'markdown');
            if (title) {
                formData.append('title', title);
            }
            formData.append('is_public', isPublic ? 'true' : 'false');
            
            uploadContent(formData, button, originalHTML);
        });
        
        // 文本分享
        document.getElementById('share-text').addEventListener('click', function() {
            const button = this;
            const originalHTML = button.innerHTML;
            
            const textContent = document.getElementById('text-editor').value.trim();
            if (!textContent) {
                showToast('请输入要分享的文本内容');
                return;
            }
            
            disableButton(button);
            
            const title = document.getElementById('content-title').value.trim();
            const isPublic = document.getElementById('is-public').checked;
            
            const formData = new FormData();
            formData.append('content', textContent);
            formData.append('type', 'text');
            if (title) {
                formData.append('title', title);
            }
            formData.append('is_public', isPublic ? 'true' : 'false');
            
            uploadContent(formData, button, originalHTML);
        });
        
        // 图片分享
        document.getElementById('share-image').addEventListener('click', function() {
            const button = this;
            const originalHTML = button.innerHTML;
            
            const imageFile = document.getElementById('image-upload').files[0];
            if (!imageFile) {
                showToast('请选择要分享的图片');
                return;
            }
            
            disableButton(button);
            
            const title = document.getElementById('content-title').value.trim();
            const isPublic = document.getElementById('is-public').checked;
            
            const formData = new FormData();
            formData.append('file', imageFile);
            formData.append('type', 'image');
            if (title) {
                formData.append('title', title);
            }
            formData.append('is_public', isPublic ? 'true' : 'false');
            
            uploadContent(formData, button, originalHTML);
        });
        
        // 统一的上传处理函数
        function uploadContent(formData, button, originalHTML) {
            fetch('/share', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('服务器响应错误: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('服务器响应:', data); // 添加调试信息
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // 显示结果并自动复制链接到剪贴板
                const shortLink = data.shortLink;
                document.getElementById('shortlink').textContent = shortLink;
                document.getElementById('result').classList.remove('hidden');
                
                // 自动复制到剪贴板
                copyToClipboard(shortLink);
                
                // 显示成功提示
                const contentType = formData.get('type');
                const typeText = contentType === 'markdown' ? 'Markdown' : 
                                contentType === 'text' ? '文本' : '图片';
                showToast(`${typeText}内容分享成功！链接已复制到剪贴板`);
                
                // 禁用输入区域
                document.getElementById('content-title').setAttribute('readonly', 'readonly');
                
                const activeContent = document.querySelector('.content:not(.hidden)');
                if (activeContent.id === 'markdown-content') {
                    easyMDE.codemirror.setOption('readOnly', true);
                } else if (activeContent.id === 'text-content') {
                    document.getElementById('text-editor').setAttribute('readonly', 'readonly');
                }
                
                // 重置按钮
                resetButton(button, originalHTML);
            })
            .catch(error => {
                console.error('上传失败:', error);
                showToast('上传失败: ' + error.message);
                resetButton(button, originalHTML);
            });
        }
    </script>
</body>
</html>